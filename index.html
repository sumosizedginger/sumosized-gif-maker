<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SumoSized GIF Maker | The Elite Browser Studio</title>
    <script>
        // Register the COI service worker to enable SharedArrayBuffer for FFmpeg.wasm
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./coi-serviceworker.js').then(() => {
                // If the page wasn't already controlled, reload to activate the SW
                if (!navigator.serviceWorker.controller) {
                    window.location.reload();
                }
            });
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/utils.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Core Blues (Primary Backgrounds) */
            --navy: #002244;
            --oxford: #002147;
            --midnight: #191970;
            --sapphire: #082567;
            --prussian: #003153;
            --charcoal: #1F2328;

            /* Core Greens (Primary Accents) */
            --action-green: #4DFF00;
            --forest: #228B22;
            --racing: #004225;
            --hunter: #355E3B;
            --sacramento: #043927;
            --jungle: #1A2421;

            /* UI Tokens */
            --vibe-color: #4DFF00;
            --glass: rgba(0, 34, 68, 0.75);
            --glass-border: rgba(77, 255, 0, 0.15);
            --text-primary: rgba(77, 255, 0, 0.95);
            --text-secondary: rgba(77, 255, 0, 0.6);
            --transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, var(--oxford), var(--navy), #000);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 40px 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        /* Ambient Glows */
        .container::before {
            content: '';
            position: absolute;
            top: -100px;
            left: -100px;
            width: 300px;
            height: 300px;
            background: var(--action-green);
            filter: blur(150px);
            opacity: 0.1;
            z-index: -1;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 1s var(--transition);
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(to bottom, var(--action-green), var(--text-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--action-green);
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 600;
            opacity: 0.9;
        }



        .mode-switcher {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 100px;
            width: fit-content;
            margin: 0 auto 30px;
            border: 1px solid var(--glass-border);
        }

        .mode-btn {
            padding: 10px 25px;
            border-radius: 100px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            font-family: 'Outfit', sans-serif;
        }

        .mode-btn.active {
            background: var(--action-green);
            color: var(--navy) !important;
            -webkit-text-fill-color: var(--navy) !important;
            box-shadow: 0 5px 15px rgba(77, 255, 0, 0.2);
            forced-color-adjust: none;
        }

        .mode-btn.active i {
            color: var(--navy) !important;
        }

        .main-card {
            background: var(--glass);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5), inset 0 0 40px rgba(77, 255, 0, 0.05);
            overflow: hidden;
            animation: fadeInUp 1s var(--transition);
        }

        .upload-section {
            padding: 80px 40px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
            border-bottom: 1px solid rgba(77, 255, 0, 0.1);
        }

        .upload-btn {
            display: inline-block;
            padding: 18px 48px;
            background: var(--action-green);
            color: var(--navy) !important;
            -webkit-text-fill-color: var(--navy) !important;
            border-radius: 100px;
            cursor: pointer;
            font-weight: 800;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: var(--transition);
            box-shadow: 0 0 20px rgba(77, 255, 0, 0.3);
            font-family: 'Outfit', sans-serif;
            forced-color-adjust: none;
        }

        .upload-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 0 40px rgba(77, 255, 0, 0.5);
            background: var(--sapphire);
            color: var(--action-green);
        }

        input[type="file"] {
            display: none;
        }

        .video-section {
            display: none;
            padding: 30px;
            background: var(--charcoal);
            position: relative;
        }

        .video-section.active {
            display: block;
        }

        video {
            width: 100%;
            max-height: 500px;
            display: block;
            border-radius: 12px;
            border: 1px solid rgba(77, 255, 0, 0.15);
        }

        .controls-panel {
            padding: 40px;
            background: rgba(0, 0, 0, 0.3);
        }

        .time-controls {
            margin-bottom: 40px;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .time-display span span {
            color: var(--action-green);
            font-weight: 700;
        }

        .range-container {
            position: relative;
            height: 48px;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 24px;
            border: 1px solid rgba(77, 255, 0, 0.1);
        }

        .range-slider {
            position: absolute;
            width: 100%;
            height: 4px;
            background: rgba(77, 255, 0, 0.15);
            border-radius: 2px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .range-selected {
            position: absolute;
            height: 4px;
            background: var(--action-green);
            box-shadow: 0 0 15px var(--action-green);
            border-radius: 2px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        input[type="range"] {
            position: absolute;
            width: 100%;
            height: 100%;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
            appearance: none;
            top: 0;
            margin: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--action-green);
            border: 4px solid var(--navy);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
            transition: var(--transition);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--vibe-color);
            box-shadow: 0 0 30px var(--action-green);
        }

        /* Firefox Support */
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--action-green);
            border: 4px solid var(--navy);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
            transition: var(--transition);
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            background: var(--vibe-color);
            box-shadow: 0 0 30px var(--action-green);
        }

        /* Edge/IE Support */
        input[type="range"]::-ms-thumb {
            width: 24px;
            height: 24px;
            background: var(--action-green);
            border: 4px solid var(--navy);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
        }

        input[type="range"]::-ms-thumb:hover {
            background: var(--vibe-color);
        }

        /* Track Purity */
        input[type="range"]::-webkit-slider-runnable-track {
            background: transparent;
        }

        input[type="range"]::-moz-range-track {
            background: transparent;
        }

        input[type="range"]::-ms-track {
            background: transparent;
            border-color: transparent;
            color: transparent;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setting-label {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .setting-input {
            padding: 14px;
            background: rgba(0, 34, 68, 0.4);
            border: 1px solid rgba(77, 255, 0, 0.1);
            border-radius: 12px;
            font-size: 1rem;
            color: var(--action-green);
            transition: var(--transition);
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--action-green);
            background: rgba(77, 255, 0, 0.15);
            box-shadow: 0 0 20px rgba(77, 255, 0, 0.1);
        }

        .slideshow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .img-preview {
            aspect-ratio: 1;
            background: rgba(0, 34, 68, 0.4);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .img-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-mode-section {
            display: none;
        }

        .image-mode-section.active {
            display: block;
        }

        footer {
            margin-top: 80px;
            text-align: center;
            padding: 20px;
            border-top: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        footer a {
            color: var(--action-green);
            text-decoration: none;
            font-weight: 700;
            transition: var(--transition);
        }

        footer a:hover {
            opacity: 0.8;
            text-shadow: 0 0 10px var(--action-green);
        }

        [data-lucide] {
            stroke-width: 2px;
        }

        /* Phase 2 Enhanced Components */
        .feature-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 100px;
            border: 1px solid rgba(77, 255, 0, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8rem;
            border-radius: 100px;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn.active {
            background: var(--action-green);
            color: var(--navy) !important;
            -webkit-text-fill-color: var(--navy) !important;
            box-shadow: 0 5px 15px rgba(77, 255, 0, 0.2);
            forced-color-adjust: none;
        }

        .tab-btn.active i {
            color: var(--navy) !important;
        }

        .advanced-panel {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.4s var(--transition);
        }

        .advanced-panel.active {
            display: block;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
        }

        .filter-card {
            background: rgba(0, 34, 68, 0.4);
            border: 1px solid rgba(77, 255, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-card:hover {
            background: rgba(0, 34, 68, 0.6);
            transform: translateY(-2px);
        }

        .filter-card.active {
            border-color: var(--action-green);
            background: rgba(77, 255, 0, 0.05);
            box-shadow: inset 0 0 10px rgba(77, 255, 0, 0.1);
        }

        .filter-label {
            display: block;
            margin-top: 8px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .size-predictor {
            margin-top: 20px;
            padding: 15px;
            background: rgba(77, 255, 0, 0.05);
            border-radius: 12px;
            border-left: 4px solid var(--action-green);
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .size-val {
            font-weight: 800;
            color: var(--action-green);
        }

        .timeline-container {
            position: relative;
            padding-top: 20px;
        }

        .frame-preview-bar {
            height: 40px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            margin-bottom: 5px;
            overflow: hidden;
            display: flex;
        }

        .frame-strip {
            height: 100%;
            flex: 1;
            background-size: cover;
            background-position: center;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .frame-strip:hover {
            opacity: 1;
        }

        .action-section {
            padding: 40px;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .btn {
            padding: 16px 40px;
            border: none;
            border-radius: 100px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            margin: 10px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: var(--action-green);
            color: var(--navy) !important;
            -webkit-text-fill-color: var(--navy) !important;
            box-shadow: 0 10px 30px rgba(77, 255, 0, 0.2);
            forced-color-adjust: none;
        }

        .btn i {
            color: inherit !important;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(77, 255, 0, 0.4);
            background: var(--action-green);
            filter: brightness(1.1);
        }

        .btn-primary:disabled {
            opacity: 0.3;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(0, 34, 68, 0.4);
            color: var(--action-green);
            border: 1px solid rgba(77, 255, 0, 0.15);
        }

        .btn-secondary:hover {
            background: rgba(77, 255, 0, 0.1);
            border-color: var(--action-green);
        }

        .progress-container {
            margin-top: 40px;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 33, 71, 0.5);
            border-radius: 100px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--action-green);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 15px var(--action-green);
        }

        .preview-section {
            display: none;
            padding: 50px 40px;
            background: rgba(0, 0, 0, 0.4);
            text-align: center;
            border-top: 1px solid rgba(77, 255, 0, 0.1);
        }

        .preview-section.active {
            display: block;
            animation: fadeIn 0.8s var(--transition);
        }

        .preview-image {
            max-width: 100%;
            border-radius: 20px;
            border: 2px solid var(--action-green);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            margin-bottom: 30px;
        }

        .video-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--action-green);
            color: var(--navy);
            padding: 16px 32px;
            border-radius: 100px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .trim-hint {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 12px;
            font-weight: 500;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Pro Cropper UI */
        .video-container {
            position: relative;
            cursor: crosshair;
            overflow: hidden;
            border-radius: 20px;
        }

        .cropper-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 10;
            pointer-events: none;
        }

        .cropper-overlay.active {
            display: block;
        }

        .cropper-box {
            position: absolute;
            border: 2px solid var(--action-green);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 20px var(--action-green);
            pointer-events: none;
        }

        .cropper-box::after {
            content: 'CROP AREA';
            position: absolute;
            top: -25px;
            left: 0;
            background: var(--action-green);
            color: var(--navy);
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Icon Tweaks */
        .tab-btn i,
        .btn i {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                margin: 5px;
                width: 100%;
                justify-content: center;
            }
        }

        .mode-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 100px;
            border: 1px solid rgba(77, 255, 0, 0.1);
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8rem;
            border-radius: 100px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-btn.active {
            background: var(--action-green);
            color: var(--navy);
            box-shadow: 0 5px 15px rgba(77, 255, 0, 0.2);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>SumoSized</h1>
            <div class="subtitle">Elite Browser GIF Studio</div>
        </header>

        <div class="mode-switcher">
            <button class="mode-btn active" onclick="switchMode('video')">
                <i data-lucide="video"></i> Video Studio
            </button>
            <button class="mode-btn" onclick="switchMode('images')">
                <i data-lucide="image"></i> Image Slideshow
            </button>
        </div>

        <div class="main-card">
            <!-- Video Upload Section -->
            <div id="videoUploadSection" class="upload-section">
                <div style="margin-bottom: 30px;">
                    <i data-lucide="clapperboard"
                        style="width: 64px; height: 64px; color: var(--action-green); opacity: 0.8;"></i>
                </div>
                <label for="videoUpload" class="upload-btn">
                    Select Elite Video
                </label>
                <input type="file" id="videoUpload" accept="video/mp4,video/x-m4v,video/*">
                <p style="margin-top: 25px; color: var(--text-secondary); font-size: 0.9rem;">
                    MP4, MOV, or WEBM up to 50MB
                </p>
            </div>

            <!-- Image Upload Section -->
            <div id="imageUploadSection" class="upload-section" style="display: none;">
                <div style="margin-bottom: 30px;">
                    <i data-lucide="images"
                        style="width: 64px; height: 64px; color: var(--action-green); opacity: 0.8;"></i>
                </div>
                <label for="imageUpload" class="upload-btn">
                    Select Elite Images
                </label>
                <input type="file" id="imageUpload" accept="image/*" multiple>
                <p style="margin-top: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                    Upload multiple images to stitch into a custom GIF
                </p>

                <div id="slideshowGrid" class="slideshow-grid"></div>
            </div>

            <div class="video-section active" id="videoSection">
                <div class="video-container" id="videoContainer">
                    <div id="loadingPlaceholder"
                        style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,34,68,0.4); border-radius: 12px; z-index: 5;">
                        <i data-lucide="monitor-play"
                            style="width: 48px; height: 48px; color: var(--action-green); margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Awaiting Elite Media...</p>
                    </div>
                    <video id="videoPlayer" style="display: none;"></video>
                    <img id="imagePlaceholder"
                        style="display: none; width: 100%; max-height: 500px; border-radius: 12px; border: 1px solid rgba(77, 255, 0, 0.15);">
                    <div class="cropper-overlay" id="cropperOverlay">
                        <div class="cropper-box" id="cropperBox"></div>
                    </div>
                </div>
                <div class="video-info" id="videoInfo"></div>
            </div>

            <div class="controls-panel" id="controlsPanel">
                <div class="time-controls" id="trimControls">
                    <div class="time-display">
                        <span>Start: <span id="startTimeDisplay">0.0s</span></span>
                        <span>Duration: <span id="durationDisplay">2.0s</span></span>
                        <span>End: <span id="endTimeDisplay">2.0s</span></span>
                    </div>

                    <div class="range-container">
                        <div class="range-slider"></div>
                        <div class="range-selected" id="rangeSelected"></div>
                        <input type="range" id="startRange" min="0" max="100" value="0" step="0.1">
                        <input type="range" id="endRange" min="0" max="100" value="20" step="0.1">
                    </div>

                    <p class="trim-hint">Drag handles to select clip region &mdash; <strong id="sliderMaxLabel">max
                            10s</strong> recommended</p>
                </div>

                <div class="feature-tabs">
                    <button class="tab-btn active" onclick="switchTab('settings')">
                        <i data-lucide="settings"></i> Settings
                    </button>
                    <button class="tab-btn" onclick="switchTab('filters')">
                        <i data-lucide="sparkles"></i> Filters
                    </button>
                    <button class="tab-btn" onclick="switchTab('overlays')">
                        <i data-lucide="type"></i> Overlays
                    </button>
                </div>

                <!-- Settings Panel -->
                <div id="settingsPanel" class="advanced-panel active">
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Width (px)</label>
                            <input type="number" id="gifWidth" class="setting-input" value="480" min="100" max="1024"
                                step="10">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">Frame Rate (FPS)</label>
                            <input type="number" id="fps" class="setting-input" value="15" min="1" max="60" step="1">
                        </div>

                        <div class="setting-group" id="speedGroup">
                            <label class="setting-label">Speed</label>
                            <select id="speed" class="setting-input" onchange="updatePredictor()">
                                <option value="0.5">0.5x (Slow)</option>
                                <option value="1" selected>1.0x (Normal)</option>
                                <option value="1.5">1.5x (Fast)</option>
                                <option value="2">2.0x (Turbo)</option>
                            </select>
                        </div>

                        <div class="setting-group" id="loopGroup">
                            <label class="setting-label">Loop Mode</label>
                            <select id="loopMode" class="setting-input" onchange="updatePredictor()">
                                <option value="normal" selected>Normal</option>
                                <option value="reverse">Reverse</option>
                                <option value="boomerang">Boomerang</option>
                            </select>
                        </div>

                        <div class="setting-group" id="delayGroup" style="display: none;">
                            <label class="setting-label">Frame Delay (ms)</label>
                            <input type="number" id="frameDelay" class="setting-input" value="200" min="50" step="50">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">Pro Crop</label>
                            <select id="cropRatio" class="setting-input" onchange="toggleCropper(this.value)">
                                <option value="off" selected>Off (Full)</option>
                                <option value="original">Free Crop</option>
                                <option value="9:16">TikTok (9:16)</option>
                                <option value="1:1">Instagram (1:1)</option>
                                <option value="4:5">FB/Portalt (4:5)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Filters Panel -->
                <div id="filtersPanel" class="advanced-panel">
                    <div class="filter-grid" id="filterGrid">
                        <div class="filter-card active" onclick="setFilter('none', this)">
                            <span class="filter-label">None</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('grayscale', this)">
                            <span class="filter-label">Noir</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('sepia', this)">
                            <span class="filter-label">Retro</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('vibrant', this)">
                            <span class="filter-label">Vibrant Pop</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('8bit', this)">
                            <span class="filter-label">8-Bit Retro</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('dreamy', this)">
                            <span class="filter-label">Dreamy Wash</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('golden', this)">
                            <span class="filter-label">Golden Hour</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('gladiator', this)">
                            <span class="filter-label">Gladiator</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('nightvision', this)">
                            <span class="filter-label">Night Vision</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('sulphur', this)">
                            <span class="filter-label">Sulphur</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('coldblue', this)">
                            <span class="filter-label">Cold Blue</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('vignette', this)">
                            <span class="filter-label">Vignette</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('mirror', this)">
                            <span class="filter-label">Mirror Flip</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('grain', this)">
                            <span class="filter-label">Film Grain</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('invert', this)">
                            <span class="filter-label">Invert</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('vhs', this)">
                            <span class="filter-label">üìº VHS Retro</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('psychedelic', this)">
                            <span class="filter-label">üåà Psychedelia</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('thermal', this)">
                            <span class="filter-label">üî• Thermal</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('glitch', this)">
                            <span class="filter-label">üëæ Glitch</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('cyberpunk', this)">
                            <span class="filter-label">üß¨ Cyberpunk</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('chrome', this)">
                            <span class="filter-label">üíø Chrome</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('blueprint', this)">
                            <span class="filter-label">üìê Blueprint</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('matrix', this)">
                            <span class="filter-label">üìü Matrix</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('oldmovie', this)">
                            <span class="filter-label">üéûÔ∏è Old Movie</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('mirrormode', this)">
                            <span class="filter-label">ü™û Kaleidoscope</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('comic', this)">
                            <span class="filter-label">üí• Comic Book</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('acid', this)">
                            <span class="filter-label">üåÄ Acid Trip</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('sketch', this)">
                            <span class="filter-label">‚úèÔ∏è Sketch</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('infrared', this)">
                            <span class="filter-label">üõ∞Ô∏è Infrared</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('seahawks', this)">
                            <span class="filter-label">ü¶Ö Seahawks</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('technicolor', this)">
                            <span class="filter-label">üìΩÔ∏è Technicolor</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('golden2', this)">
                            <span class="filter-label">üèÜ Golden II</span>
                        </div>
                        <div class="filter-card" onclick="setFilter('posterize', this)">
                            <span class="filter-label">üé® Posterize</span>
                        </div>
                    </div>
                </div>

                <!-- Overlays Panel -->
                <div id="overlaysPanel" class="advanced-panel">
                    <div class="setting-group">
                        <label class="setting-label">Overlay Text</label>
                        <input type="text" id="overlayText" class="setting-input" placeholder="Enter caption..."
                            oninput="updatePredictor()">
                    </div>
                    <div class="settings-grid" style="margin-top: 15px;">
                        <div class="setting-group">
                            <label class="setting-label">Size</label>
                            <input type="number" id="textSize" class="setting-input" value="32" min="10" max="100">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Position</label>
                            <select id="textPos" class="setting-input">
                                <option value="top">Top</option>
                                <option value="middle">Middle</option>
                                <option value="bottom" selected>Bottom</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Word Spacing</label>
                            <input type="number" id="wordSpacing" class="setting-input" value="1" min="0" max="50">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Font Family</label>
                            <select id="fontStyle" class="setting-input">
                                <option value="Arimo-Regular.ttf">Standard (Arimo)</option>
                                <option value="LiberationSans-Regular.ttf">Liberation Sans</option>
                                <option value="Roboto-Regular.ttf">Roboto (Modern)</option>
                                <option value="Anton-Regular.ttf">Anton (Headline)</option>
                                <option value="Orbitron.ttf">Orbitron (Sci-Fi)</option>
                                <option value="PermanentMarker-Regular.ttf">Marker (Street)</option>
                                <option value="Montserrat-Regular.ttf">Montserrat</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Line Spacing</label>
                            <input type="number" id="lineSpacing" class="setting-input" value="20" min="0" max="100">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Text Box</label>
                            <select id="textBox" class="setting-input">
                                <option value="0" selected>None</option>
                                <option value="1">Background Slug</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Text Color</label>
                            <select id="textColor" class="setting-input">
                                <option value="#4DFF00" selected>Action Green</option>
                                <option value="cyan">Cyan</option>
                                <option value="yellow">Yellow</option>
                                <option value="red">Red</option>
                                <option value="black">Black</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Box Padding</label>
                            <input type="number" id="boxPadding" class="setting-input" value="10" min="0" max="50">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Box Opacity</label>
                            <input type="number" id="boxOpacity" class="setting-input" value="0.5" min="0" max="1"
                                step="0.1">
                        </div>
                    </div>
                </div>

                <div class="size-predictor">
                    <span>Quality Index: <span class="size-val" id="qualityEst">Ultra High</span></span>
                    <span>| Processor: <span class="size-val">Elite (FFmpeg)</span></span>
                </div>
            </div>

            <div class="action-section" id="actionSection" style="display: none;">
                <button class="btn btn-primary" id="convertBtn" onclick="startConversion()">
                    ‚ö° Convert to GIF
                </button>
                <button class="btn btn-secondary" onclick="resetVideo()">
                    üóëÔ∏è New Video
                </button>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-info">
                        <span id="progressStatus">Extracting frames...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <div class="preview-section" id="previewSection">
                <h3 style="margin-bottom: 20px; color: var(--action-green);">‚ú® Your GIF is Ready!</h3>
                <img id="resultGif" class="preview-image" src="" alt="Generated GIF">
                <div>
                    <a id="downloadBtn" class="btn btn-primary" download="converted.gif">
                        ‚¨áÔ∏è Download GIF
                    </a>
                    <button class="btn btn-secondary" onclick="closePreview()">
                        üîÑ Convert Another Section
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const CONFIG = {
            FFMPEG_CORE_URL: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
            // Default Font (OSS Arimo - Arial compatible)
            FONT_URL: window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '') + '/fonts/Arimo-Regular.ttf',
            FONT_BASE_URL: window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '') + '/fonts/'
        };

        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            corePath: CONFIG.FFMPEG_CORE_URL
        });

        let videoDuration = 0;
        let isConverting = false;
        let currentFilter = 'none';
        let currentVideoFile = null;
        let currentMode = 'video';
        let slideshowImages = [];

        // *** CRITICAL: Must be declared early ‚Äî HTML `onchange` calls toggleCropper before script execution reaches later `let` declarations ***
        let cropData = { active: false, x: 0, y: 0, w: 0, h: 0, ratio: 'off' };
        let isDragging = false;
        let startX, startY;

        const colorThief = new ColorThief();

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));

            const targetBtn = Array.from(document.querySelectorAll('.mode-btn'))
                .find(btn => btn.innerText.toLowerCase().includes(mode));
            if (targetBtn) targetBtn.classList.add('active');

            const loadingPlaceholder = document.getElementById('loadingPlaceholder');
            const videoPlayer = document.getElementById('videoPlayer');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const actionSection = document.getElementById('actionSection');

            if (mode === 'video') {
                document.getElementById('videoUploadSection').style.display = 'block';
                document.getElementById('imageUploadSection').style.display = 'none';
                document.getElementById('trimControls').style.display = 'block';
                document.getElementById('speedGroup').style.display = 'block';
                document.getElementById('loopGroup').style.display = 'block';
                document.getElementById('delayGroup').style.display = 'none';

                if (currentVideoFile) {
                    loadingPlaceholder.style.display = 'none';
                    videoPlayer.style.display = 'block';
                    imagePlaceholder.style.display = 'none';
                    actionSection.style.display = 'block';
                } else {
                    loadingPlaceholder.style.display = 'flex';
                    videoPlayer.style.display = 'none';
                    actionSection.style.display = 'none';
                }
            } else { // Image mode
                document.getElementById('videoUploadSection').style.display = 'none';
                document.getElementById('imageUploadSection').style.display = 'block';
                document.getElementById('trimControls').style.display = 'none';
                document.getElementById('speedGroup').style.display = 'none';
                document.getElementById('loopGroup').style.display = 'none';
                document.getElementById('delayGroup').style.display = 'block';

                if (slideshowImages.length > 0) {
                    loadingPlaceholder.style.display = 'none';
                    videoPlayer.style.display = 'none';
                    imagePlaceholder.style.display = 'block';
                    actionSection.style.display = 'block';
                    if (!imagePlaceholder.src) imagePlaceholder.src = slideshowImages[0];
                } else {
                    loadingPlaceholder.style.display = 'flex';
                    imagePlaceholder.style.display = 'none';
                    actionSection.style.display = 'none';
                }
            }
            closePreview();
        }

        // (First duplicate listener removed ‚Äî the authoritative handler with metadata is below)

        // Image Slideshow Logic
        document.getElementById('imageUpload').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            slideshowImages = [];
            const grid = document.getElementById('slideshowGrid');
            grid.innerHTML = '';

            for (const file of files) {
                const url = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                slideshowImages.push(url);

                const div = document.createElement('div');
                div.className = 'img-preview';
                div.innerHTML = `<img src="${url}">`;
                grid.appendChild(div);
            }

            if (slideshowImages.length > 0) {
                document.getElementById('videoUploadSection').style.display = 'none';
                document.getElementById('imageUploadSection').style.display = 'none';
                document.getElementById('videoSection').classList.add('active');
                document.getElementById('videoSection').style.display = 'block';
                document.getElementById('controlsPanel').style.display = 'block';
                document.getElementById('actionSection').style.display = 'block';

                // Display first image in preview area for cropping logic
                const videoPlayer = document.getElementById('videoPlayer');
                const imagePlaceholder = document.getElementById('imagePlaceholder');
                videoPlayer.style.display = 'none';
                imagePlaceholder.style.display = 'block';
                imagePlaceholder.src = slideshowImages[0];

                showToast(`Loaded ${slideshowImages.length} images. Sync Vibe & Start FX!`);
                updatePredictor();
            }
        });

        // (Dead code removed: createSlideshowBtn was the old gifshot path. Image GIFs now use the unified convertBtn + FFmpeg engine.)

        // Initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        async function syncVibe() {
            const videoPlayer = document.getElementById('videoPlayer');
            if (!videoPlayer) return;

            if (!videoPlayer.paused || videoPlayer.currentTime > 0) {
                const canvas = document.createElement('canvas');
                canvas.width = videoPlayer.videoWidth;
                canvas.height = videoPlayer.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

                try {
                    const color = colorThief.getColor(canvas);
                    const rgb = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                    document.documentElement.style.setProperty('--vibe-color', rgb);
                    document.documentElement.style.setProperty('--glass-border', `rgba(${color[0]}, ${color[1]}, ${color[2]}, 0.3)`);
                } catch (e) {
                    console.warn("Vibe sync failed:", e);
                }
            }
        }

        // *** CRITICAL FIX: was incorrectly delegating to 'videoInput' ‚Äî the element is 'videoUpload' ***
        // This is now the single, authoritative handler for video uploads.
        document.getElementById('videoUpload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const videoPlayer = document.getElementById('videoPlayer');
            const loadingPlaceholder = document.getElementById('loadingPlaceholder');
            const startRangeEl = document.getElementById('startRange');
            const endRangeEl = document.getElementById('endRange');
            const actionSection = document.getElementById('actionSection');

            if (videoPlayer.src) URL.revokeObjectURL(videoPlayer.src);
            currentVideoFile = file;
            videoPlayer.src = URL.createObjectURL(file);

            document.getElementById('videoUploadSection').style.display = 'none';
            videoPlayer.style.display = 'block';
            if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
            if (actionSection) actionSection.style.display = 'block';

            videoPlayer.onloadedmetadata = function () {
                videoDuration = videoPlayer.duration;

                setTimeout(syncVibe, 500);

                document.getElementById('videoInfo').innerHTML = `
                    <span>üìπ ${file.name}</span>
                    <span>‚è±Ô∏è ${formatTime(videoDuration)}</span>
                    <span>üìê ${Math.round(videoPlayer.videoWidth)}x${Math.round(videoPlayer.videoHeight)}</span>
                `;

                if (startRangeEl) {
                    startRangeEl.max = videoDuration;
                    startRangeEl.value = 0;
                }
                if (endRangeEl) {
                    endRangeEl.max = videoDuration;
                    const GIF_MAX = Math.min(10, videoDuration);
                    endRangeEl.value = GIF_MAX;
                    const label = document.getElementById('sliderMaxLabel');
                    if (label) label.textContent = `max ${GIF_MAX.toFixed(1)}s (video: ${videoDuration.toFixed(1)}s)`;
                }

                updateRange();
                updatePredictor();
                showToast('Video Loaded! Trim & Sync Vibe.');
            };
        });


        function switchTab(tabId) {
            document.querySelectorAll('.advanced-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(tabId + 'Panel').classList.add('active');
            event.target.classList.add('active');
        }

        function setFilter(filter, el) {
            currentFilter = filter;
            document.querySelectorAll('.filter-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            updatePredictor();
        }

        function updatePredictor() {
            const widthInput = document.getElementById('gifWidth');
            const fpsInput = document.getElementById('fps');
            const speedInput = document.getElementById('speed');
            const overlayInput = document.getElementById('overlayText');
            const qualityEst = document.getElementById('qualityEst');

            if (!widthInput || !fpsInput || !speedInput || !overlayInput || !qualityEst) return;

            const width = parseInt(widthInput.value);
            const fps = parseInt(fpsInput.value);
            const speed = parseFloat(speedInput.value);
            const hasOverlay = overlayInput.value.length > 0;

            let quality = "High Def";
            if (width > 800) quality = "Ultra HD";
            else if (width < 320) quality = "Standard";

            if (fps > 25) quality += " (Super Smooth)";
            if (hasOverlay) quality += " + FX";

            qualityEst.textContent = quality;
        }

        function updateRange() {
            const startRange = document.getElementById('startRange');
            const endRange = document.getElementById('endRange');
            const rangeSelected = document.getElementById('rangeSelected');
            const startTimeDisplay = document.getElementById('startTimeDisplay');
            const endTimeDisplay = document.getElementById('endTimeDisplay');
            const durationDisplay = document.getElementById('durationDisplay');

            if (!startRange || !endRange) return;

            let start = parseFloat(startRange.value);
            let end = parseFloat(endRange.value);

            // Ensure minimum 0.5s duration and maximum 10s duration
            if (end - start < 0.5) {
                if (event && event.target === startRange) {
                    start = Math.max(0, end - 0.5);
                    startRange.value = start;
                } else {
                    end = Math.min(videoDuration, start + 0.5);
                    endRange.value = end;
                }
            }

            if (end - start > 10) {
                if (event && event.target === startRange) {
                    end = start + 10;
                    endRange.value = end;
                } else {
                    start = end - 10;
                    startRange.value = start;
                }
            }

            if (start > end) {
                const temp = start;
                start = end;
                end = temp;
            }

            // Update visual range
            const leftPercent = (start / videoDuration) * 100;
            const widthPercent = ((end - start) / videoDuration) * 100;

            if (rangeSelected) {
                rangeSelected.style.left = leftPercent + '%';
                rangeSelected.style.width = widthPercent + '%';
            }

            // Update displays
            if (startTimeDisplay) startTimeDisplay.textContent = start.toFixed(1) + 's';
            if (endTimeDisplay) endTimeDisplay.textContent = end.toFixed(1) + 's';
            if (durationDisplay) durationDisplay.textContent = (end - start).toFixed(1) + 's';
        }

        // These event listeners might not be defined if the elements are not present on page load
        // It's safer to add them after the elements are confirmed to exist, or inside a function that's called when they do.
        // For now, assuming they are globally accessible after the DOM is ready.
        const startRange = document.getElementById('startRange');
        const endRange = document.getElementById('endRange');
        if (startRange) startRange.addEventListener('input', updateRange);
        if (endRange) endRange.addEventListener('input', updateRange);

        // cropData and dragging state are declared at the top of the script block (before HTML onchange can fire)

        function toggleCropper(ratio) {
            const videoPlayer = document.getElementById('videoPlayer');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const targetEl = currentMode === 'video' ? videoPlayer : imagePlaceholder;
            const overlay = document.getElementById('cropperOverlay');
            const box = document.getElementById('cropperBox');

            if (!targetEl || !overlay) return;

            if (ratio === 'off') {
                overlay.classList.remove('active');
                cropData.active = false;
                return;
            }

            overlay.classList.add('active');
            cropData.active = true;
            cropData.ratio = ratio;

            // Reset box to center
            const rect = targetEl.getBoundingClientRect();
            let w = rect.width * 0.5; // Default to 50% width
            let h = rect.height * 0.5; // Default to 50% height

            if (ratio !== 'original') {
                const [rW, rH] = ratio.split(':').map(Number);
                const targetRatio = rW / rH;
                if (w / h > targetRatio) {
                    w = h * targetRatio;
                } else {
                    h = w / targetRatio;
                }

                // Clamp to element bounds
                if (w > rect.width * 0.9) {
                    w = rect.width * 0.9;
                    h = w / targetRatio;
                }
                if (h > rect.height * 0.9) {
                    h = rect.height * 0.9;
                    w = h * targetRatio;
                }
            }

            cropData.w = w;
            cropData.h = h;
            cropData.x = (rect.width - w) / 2;
            cropData.y = (rect.height - h) / 2;

            updateCropperUI();
        }

        function updateCropperUI() {
            const box = document.getElementById('cropperBox');
            box.style.left = cropData.x + 'px';
            box.style.top = cropData.y + 'px';
            box.style.width = cropData.w + 'px';
            box.style.height = cropData.h + 'px';
        }

        const videoContainer = document.getElementById('videoContainer');
        if (videoContainer) { // Check if videoContainer exists before adding event listeners
            videoContainer.addEventListener('mousedown', e => {
                if (!cropData.active) return;
                isDragging = true;
                startX = e.offsetX;
                startY = e.offsetY;

                // If clicking outside box, start new box
                if (cropData.ratio === 'original') {
                    cropData.x = startX;
                    cropData.y = startY;
                    cropData.w = 0;
                    cropData.h = 0;
                }
            });
        }


        window.addEventListener('mousemove', e => {
            if (!isDragging) return;
            const rect = videoContainer.getBoundingClientRect();
            let curX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
            let curY = Math.max(0, Math.min(e.clientY - rect.top, rect.height));

            if (cropData.ratio === 'original') {
                cropData.w = Math.abs(curX - startX);
                cropData.h = Math.abs(curY - startY);
                cropData.x = Math.min(curX, startX);
                cropData.y = Math.min(curY, startY);
            } else {
                // Move logic for fixed ratio (simple center-drag for now)
                cropData.x = Math.max(0, Math.min(curX - cropData.w / 2, rect.width - cropData.w));
                cropData.y = Math.max(0, Math.min(curY - cropData.h / 2, rect.height - cropData.h));
            }
            updateCropperUI();
        });

        window.addEventListener('mouseup', () => isDragging = false);

        // Initialize Lucide Icons initially
        window.addEventListener('load', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });

        // FFmpeg Initialization with Logger
        let ffmpegLogs = [];
        (async () => {
            try {
                // Enable console logging for diagnostics
                ffmpeg.setLogger(({ type, message }) => {
                    console.log(`[FFmpeg ${type}] ${message}`);
                    if (type === 'fferr') {
                        ffmpegLogs.push(message);
                        if (ffmpegLogs.length > 5) ffmpegLogs.shift();
                    }
                });

                if (!ffmpeg.isLoaded()) {
                    await ffmpeg.load();
                    showToast("Elite Processor Ready");
                }
            } catch (e) {
                console.error(e);
                showToast("System Error: Cross-Origin Isolation Required");
            }
        })();

        function wrapText(text, maxWidth, fontSize, fontName, wordSpacing = 0) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.font = `${fontSize}px "${fontName}", Arial`;

            // Measure the exact width of a space in the current font
            const spaceWidth = ctx.measureText(' ').width;
            const extraSpacingPx = wordSpacing * spaceWidth;

            const words = text.split(' ');
            let lines = [];
            let currentLine = [];

            words.forEach(word => {
                const testLine = [...currentLine, word];
                const testText = testLine.join(' ');
                const metrics = ctx.measureText(testText);
                // Total width = text width + (number of gaps * extra spacing per gap)
                const totalWidth = metrics.width + (Math.max(0, testLine.length - 1) * extraSpacingPx);

                if (totalWidth > maxWidth && currentLine.length > 0) {
                    lines.push(currentLine.join(' '));
                    currentLine = [word];
                } else {
                    currentLine = testLine;
                }
            });
            if (currentLine.length > 0) {
                lines.push(currentLine.join(' '));
            }

            // After wrapping, inject the extra spaces for the FFmpeg workaround
            const spacingStr = ' '.repeat(wordSpacing + 1);
            return lines.map(l => l.split(' ').join(spacingStr)).join('\n');
        }

        async function startConversion() {
            if (isConverting) return;
            if (!ffmpeg.isLoaded()) {
                showToast("Processor Loading...");
                await ffmpeg.load();
            }

            // Fresh lookups for stability during reloads
            const startRange = document.getElementById('startRange');
            const endRange = document.getElementById('endRange');
            const durationDisplay = document.getElementById('durationDisplay');
            const gifWidthInput = document.getElementById('gifWidth');
            const fpsInput = document.getElementById('fps');
            const speedSelect = document.getElementById('speed');
            const loopModeSelect = document.getElementById('loopMode');
            const overlayTextInput = document.getElementById('overlayText');
            const textSizeInput = document.getElementById('textSize');
            const textPosSelect = document.getElementById('textPos');
            const convertBtn = document.getElementById('convertBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressStatus = document.getElementById('progressStatus');
            const videoPlayer = document.getElementById('videoPlayer');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const targetEl = currentMode === 'video' ? videoPlayer : imagePlaceholder;

            if (!startRange || !durationDisplay || !convertBtn || !progressContainer || !videoPlayer) {
                showToast("Page not ready ‚Äî please reload.");
                return;
            }

            const start = parseFloat(startRange.value);
            const duration = parseFloat(durationDisplay.textContent);
            const width = parseInt(gifWidthInput.value);
            const fps = parseInt(fpsInput.value);
            const speed = parseFloat(speedSelect.value);
            const loopMode = loopModeSelect.value;
            const overlayText = overlayTextInput.value;
            const textSize = parseInt(textSizeInput.value);
            const textPos = textPosSelect.value;
            const fontStyle = document.getElementById('fontStyle').value;

            convertBtn.disabled = true;
            convertBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Processing...';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            progressContainer.classList.add('active');

            try {
                if (currentMode === 'video') {
                    ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(currentVideoFile));
                }

                // Load font and write text file if overlay text is present
                if (overlayText) {
                    const fontMap = {
                        'Arimo-Regular.ttf': CONFIG.FONT_BASE_URL + 'Arimo-Regular.ttf',
                        'LiberationSans-Regular.ttf': CONFIG.FONT_BASE_URL + 'LiberationSans-Regular.ttf',
                        'Roboto-Regular.ttf': CONFIG.FONT_BASE_URL + 'Roboto-Regular.ttf',
                        'Anton-Regular.ttf': CONFIG.FONT_BASE_URL + 'Anton-Regular.ttf',
                        'Orbitron.ttf': CONFIG.FONT_BASE_URL + 'Orbitron-Regular.ttf',
                        'PermanentMarker-Regular.ttf': CONFIG.FONT_BASE_URL + 'PermanentMarker-Regular.ttf',
                        'Montserrat-Regular.ttf': CONFIG.FONT_BASE_URL + 'Montserrat-Regular.ttf'
                    };

                    const fontUrl = fontMap[fontStyle] || CONFIG.FONT_URL;
                    const fontName = fontStyle.split('.')[0];

                    progressStatus.textContent = 'Loading Font...';

                    // A. Update Browser Font System (for Canvas measurement)
                    if (!document.fonts.check(`${textSize}px "${fontName}"`)) {
                        try {
                            const fontFace = new FontFace(fontName, `url(${fontUrl})`);
                            const loadedFace = await fontFace.load();
                            document.fonts.add(loadedFace);
                            await document.fonts.ready;
                        } catch (e) {
                            console.warn("Browser font load failed:", e);
                        }
                    }

                    // B. Update FFmpeg Filesystem
                    ffmpeg.FS('writeFile', fontStyle, await fetchFile(fontUrl));

                    // C. Smart Wrap Logic: Zero-Guesswork Canvas measurement
                    const wordSpacing = parseInt(document.getElementById('wordSpacing').value) || 0;

                    // Verify font is actually loaded in the browser's engine before measuring
                    const fontReady = document.fonts.check(`${textSize}px "${fontName}"`);
                    if (!fontReady) {
                        console.warn(`Font ${fontName} not verified in browser cache. Waiting for system...`);
                    }
                }

                // --- Part 1: Build Filter Chain ---
                const baseFilters = [];
                const resWidth = parseInt(gifWidthInput.value) || 480;
                const currentFps = parseInt(fpsInput.value) || 15; // Renamed to avoid conflict with outer 'fps'
                const currentSpeed = parseFloat(speedSelect.value) || 1; // Renamed to avoid conflict with outer 'speed'
                const currentLoopMode = loopModeSelect.value; // Renamed to avoid conflict with outer 'loopMode'
                const currentOverlayText = overlayTextInput.value;
                const currentFontStyle = document.getElementById('fontStyle').value;
                const currentTextSize = parseInt(textSizeInput.value) || 32;
                const currentTextPos = textPosSelect.value;

                // A. Cropping ‚Äî accounts for object-fit:contain letterboxing
                if (cropData.active && cropData.w > 0) {
                    const rect = targetEl.getBoundingClientRect();
                    const realW = currentMode === 'video' ? videoPlayer.videoWidth : imagePlaceholder.naturalWidth;
                    const realH = currentMode === 'video' ? videoPlayer.videoHeight : imagePlaceholder.naturalHeight;

                    // Calculate the actual rendered size of the video inside the element (letterbox math)
                    const elAspect = rect.width / rect.height;
                    const vidAspect = realW / realH;
                    let rendW, rendH, offsetX, offsetY;
                    if (vidAspect > elAspect) {
                        // Pillarbox: video is wider than element
                        rendW = rect.width;
                        rendH = rect.width / vidAspect;
                        offsetX = 0;
                        offsetY = (rect.height - rendH) / 2;
                    } else {
                        // Letterbox: video is taller than element
                        rendH = rect.height;
                        rendW = rect.height * vidAspect;
                        offsetX = (rect.width - rendW) / 2;
                        offsetY = 0;
                    }

                    // Crop coords are relative to container; subtract letterbox offset first
                    const scaleX = realW / rendW;
                    const scaleY = realH / rendH;
                    const cX = Math.round(Math.max(0, cropData.x - offsetX) * scaleX);
                    const cY = Math.round(Math.max(0, cropData.y - offsetY) * scaleY);
                    const cW = Math.round(cropData.w * scaleX);
                    const cH = Math.round(cropData.h * scaleY);
                    // Clamp to actual video dimensions
                    const safeCW = Math.min(cW, realW - cX);
                    const safeCH = Math.min(cH, realH - cY);
                    if (safeCW > 0 && safeCH > 0) baseFilters.push(`crop=${safeCW}:${safeCH}:${cX}:${cY}`);
                }

                // B. Speed
                if (currentSpeed !== 1 && currentMode === 'video') baseFilters.push(`setpts=${1 / currentSpeed}*PTS`);

                // C. Visual Filters ‚Äî full arsenal
                if (currentFilter === 'grayscale') baseFilters.push('hue=s=0');
                if (currentFilter === 'sepia') baseFilters.push('colorchannelmixer=.393:.769:.189:0:.349:.686:.168:0:.272:.534:.131');
                if (currentFilter === 'vibrant') baseFilters.push('eq=saturation=1.5:contrast=1.1');
                if (currentFilter === '8bit') baseFilters.push('scale=iw/4:-2,scale=iw*4:-2:flags=neighbor');
                if (currentFilter === 'dreamy') baseFilters.push('eq=contrast=0.8:brightness=0.05:saturation=0.7');
                if (currentFilter === 'golden') baseFilters.push('curves=red=\'0/0 0.5/0.6 1/1\':green=\'0/0 0.5/0.45 1/0.9\':blue=\'0/0 0.5/0.3 1/0.7\'');
                if (currentFilter === 'gladiator') baseFilters.push('eq=contrast=1.5:saturation=0.5:brightness=-0.05,colorchannelmixer=1.1:0:0:0:0:0.9:0:0:0:0:0.7:0');
                if (currentFilter === 'nightvision') baseFilters.push('colorchannelmixer=0:0:0:0:0.5:0.5:0:0:0:0:0:0,eq=brightness=0.1:saturation=2,noise=alls=15:allf=t+u');
                if (currentFilter === 'sulphur') baseFilters.push('curves=red=\'0/0 0.5/0.8 1/1\':green=\'0/0 0.5/0.7 1/0.9\':blue=\'0/0 0.5/0.1 1/0.2\'');
                if (currentFilter === 'coldblue') baseFilters.push('curves=red=\'0/0 0.5/0.3 1/0.7\':green=\'0/0 0.5/0.5 1/0.8\':blue=\'0/0 0.5/0.7 1/1\'');
                if (currentFilter === 'vignette') baseFilters.push('vignette=PI/4');
                if (currentFilter === 'mirror') baseFilters.push('hflip');
                if (currentFilter === 'grain') baseFilters.push('noise=alls=20:allf=t+u');
                if (currentFilter === 'invert') baseFilters.push('negate');
                if (currentFilter === 'vhs') baseFilters.push('hue=s=0.5,noise=alls=10:allf=t+u,boxblur=lx=1:ly=1');
                if (currentFilter === 'psychedelic') baseFilters.push('hue=h=\'t*50\',eq=saturation=2');
                if (currentFilter === 'thermal') baseFilters.push('curves=r=\'0/0 0.1/1 1/1\':g=\'0/1 0.5/0 1/1\':b=\'0/0.5 1/0\'');
                if (currentFilter === 'glitch') baseFilters.push('noise=alls=20:allf=t+u,hue=h=\'t*10\':s=1.2,boxblur=2:1');
                if (currentFilter === 'cyberpunk') baseFilters.push('eq=contrast=1.8:saturation=1.5,curves=r=\'0/0 0.5/1 1/1\':g=\'0/0 0.5/0 1/0.5\':b=\'0/0 0.5/1 1/1\'');
                if (currentFilter === 'chrome') baseFilters.push('format=gray,curves=all=\'0/0 0.25/0.5 0.5/1 0.75/0.5 1/0\',eq=contrast=1.5');
                if (currentFilter === 'blueprint') baseFilters.push('negate,hue=h=240:s=1,eq=contrast=1.2');
                if (currentFilter === 'matrix') baseFilters.push('format=gray,colorlevels=rimin=0.05:gimin=0.05:bimin=0.05:rimax=0.1:gimax=0.9:bimax=0.1,eq=contrast=1.5,hue=h=120:s=1');
                if (currentFilter === 'oldmovie') baseFilters.push('format=gray,noise=alls=20:allf=t+u,curves=all=\'0/0 0.5/0.4 1/1\'');
                if (currentFilter === 'mirrormode') baseFilters.push('split[main][tmp];[tmp]hflip[left];[main][left]hstack');
                if (currentFilter === 'comic') baseFilters.push('edgedetect=low=0.1:high=0.2,negate,eq=contrast=1.5:saturation=2,format=gray,colorlevels=rimax=0.8:gimax=0.8:bimax=0.8');
                if (currentFilter === 'acid') baseFilters.push('hue=h=\'t*180\':s=2,curves=all=\'0/0 0.5/1 1/0\'');
                if (currentFilter === 'sketch') baseFilters.push('edgedetect=low=0.1:high=0.2,negate,format=gray,noise=alls=5:allf=t+u');
                if (currentFilter === 'infrared') baseFilters.push('curves=r=\'0/1 0.5/0 1/0\':g=\'0/0 0.5/1 1/0\':b=\'0/0 0.5/0 1/1\'');
                if (currentFilter === 'seahawks') baseFilters.push('format=gray,curves=r=\'0/0 1/0.3\':g=\'0/0.1 1/1\':b=\'0/0 1/0\'');
                if (currentFilter === 'technicolor') baseFilters.push('colorchannelmixer=1.1:0:0:0:0:1.3:0:0:0:0:1.1:0');
                if (currentFilter === 'golden2') baseFilters.push('curves=all=\'0/0 0.5/0.6 1/1\',colorchannelmixer=1.2:0:0:0:0:1:0:0:0:0:0.8:0');
                if (currentFilter === 'posterize') baseFilters.push('posterize=bits=3');

                // D. Sizing & FPS
                baseFilters.push(`scale=${resWidth}:-2:flags=lanczos`);
                baseFilters.push(`fps=${currentFps}`);

                // E. Text Overlay
                if (currentOverlayText) {
                    let yPos;
                    switch (currentTextPos) {
                        case 'top': yPos = '20'; break;
                        case 'middle': yPos = '(h-text_h)/2'; break;
                        case 'bottom': yPos = '(h-text_h-20)'; break;
                        default: yPos = '(h-text_h-20)';
                    }

                    const wordSpacing = parseInt(document.getElementById('wordSpacing').value) || 0;
                    const fontName = currentFontStyle.split('.')[0];
                    const wrapped = wrapText(currentOverlayText.trim(), resWidth * 0.8, currentTextSize, fontName, wordSpacing);
                    ffmpeg.FS('writeFile', 'overlay_text.txt', new TextEncoder().encode(wrapped));

                    const lineSpacing = parseInt(document.getElementById('lineSpacing').value) || 10;
                    const useBox = document.getElementById('textBox').value === "1" ? 1 : 0;
                    const boxPadding = parseInt(document.getElementById('boxPadding').value) || 10;
                    const textColor = document.getElementById('textColor').value;
                    const boxOpacity = document.getElementById('boxOpacity').value;

                    baseFilters.push(`drawtext=fontfile=/${currentFontStyle}:textfile=/overlay_text.txt:fontsize=${currentTextSize}:fontcolor=${textColor}:borderw=2:bordercolor=black:line_spacing=${lineSpacing}:box=${useBox}:boxcolor=black@${boxOpacity}:boxborderw=${boxPadding}:x=(w-text_w)/2:y=${yPos}`);
                }

                const baseFilterStr = baseFilters.join(',');

                // --- Part 2: IO Setup ---
                if (currentMode === 'video') {
                    const startRaw = parseFloat(startRange.value);
                    const durRaw = parseFloat(durationDisplay.textContent);

                    progressStatus.textContent = 'Pass 1: Analyzing...';
                    await ffmpeg.run(
                        '-fflags', '+genpts',
                        '-ss', startRaw.toString(),
                        '-t', (durRaw / currentSpeed).toString(),
                        '-i', '/input.mp4',
                        '-vf', `${baseFilterStr},palettegen`,
                        '-y', '/palette.png'
                    );

                    progressStatus.textContent = 'Pass 2: Encoding...';
                    let complexFilter = `[0:v]${baseFilterStr}`;
                    if (currentLoopMode === 'reverse') complexFilter += `,reverse[vid];[vid][1:v]paletteuse`;
                    else if (currentLoopMode === 'boomerang') complexFilter += `,split[f][b];[b]reverse[r];[f][r]concat=n=2:v=1:a=0[vid];[vid][1:v]paletteuse`;
                    else complexFilter += `[vid];[vid][1:v]paletteuse`;

                    await ffmpeg.run(
                        '-fflags', '+genpts',
                        '-ss', startRaw.toString(),
                        '-t', (durRaw / currentSpeed).toString(),
                        '-i', '/input.mp4',
                        '-i', '/palette.png',
                        '-filter_complex', complexFilter,
                        '-f', 'gif',
                        '-y', '/output.gif'
                    );
                } else {
                    // IMAGE MODE
                    progressStatus.textContent = 'Preparing images...';
                    for (let i = 0; i < slideshowImages.length; i++) {
                        const dataURL = slideshowImages[i];
                        const binary = await fetch(dataURL).then(res => res.arrayBuffer());
                        ffmpeg.FS('writeFile', `/img${(i + 1).toString().padStart(3, '0')}.jpg`, new Uint8Array(binary));
                    }

                    const delay = parseInt(document.getElementById('frameDelay').value) || 200;
                    const framerate = 1000 / delay;

                    progressStatus.textContent = 'Pass 1: Analyzing...';
                    await ffmpeg.run(
                        '-framerate', framerate.toString(),
                        '-i', '/img%03d.jpg',
                        '-vf', `${baseFilterStr},palettegen`,
                        '-y', '/palette.png'
                    );

                    progressStatus.textContent = 'Pass 2: Stitching FX...';
                    await ffmpeg.run(
                        '-framerate', framerate.toString(),
                        '-i', '/img%03d.jpg',
                        '-i', '/palette.png',
                        '-filter_complex', `[0:v]${baseFilterStr}[vid];[vid][1:v]paletteuse`,
                        '-f', 'gif',
                        '-y', '/output.gif'
                    );
                }

                let data;
                try {
                    data = ffmpeg.FS('readFile', '/output.gif');
                } catch (e) {
                    let logError = ffmpegLogs.length > 0 ? " Last error: " + ffmpegLogs[ffmpegLogs.length - 1] : "";
                    throw new Error("GIF generation failed during encoding." + logError);
                }

                if (!data || data.length < 100) {
                    let logError = ffmpegLogs.length > 0 ? " Last error: " + ffmpegLogs[ffmpegLogs.length - 1] : "";
                    throw new Error("GIF output is empty ‚Äî FFmpeg filter may be invalid for this video." + logError);
                }

                const resultGif = document.getElementById('resultGif');
                if (resultGif.src) URL.revokeObjectURL(resultGif.src);
                resultGif.src = URL.createObjectURL(new Blob([data.buffer], { type: 'image/gif' }));

                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = resultGif.src;
                downloadBtn.download = `sumosized-${Date.now()}.gif`;

                document.getElementById('previewSection').classList.add('active');
                showToast('Elite GIF Generated!');
                document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });

                // Cleanup virtual files
                try {
                    if (currentMode === 'video') ffmpeg.FS('unlink', '/input.mp4');
                    else {
                        for (let i = 0; i < slideshowImages.length; i++) {
                            ffmpeg.FS('unlink', `/img${(i + 1).toString().padStart(3, '0')}.jpg`);
                        }
                    }
                    ffmpeg.FS('unlink', '/palette.png');
                    ffmpeg.FS('unlink', '/output.gif');
                    if (currentOverlayText) ffmpeg.FS('unlink', '/overlay_text.txt');
                } catch (e) { }

            } catch (error) {
                console.error("Conversion Error:", error);
                showToast('Processing Error: ' + error.message);
            } finally {
                resetConversionState();
            }
        }

        function resetConversionState() {
            isConverting = false;
            const convertBtn = document.getElementById('convertBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');

            if (convertBtn) {
                convertBtn.disabled = false;
                convertBtn.innerHTML = '‚ö° Convert to GIF';
            }
            if (progressContainer) progressContainer.classList.remove('active');
            if (progressFill) progressFill.style.width = '0%';
        }

        function resetVideo() {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSection = document.getElementById('videoSection');
            const controlsPanel = document.getElementById('controlsPanel');
            const actionSection = document.getElementById('actionSection');
            const previewSection = document.getElementById('previewSection');
            const videoUpload = document.getElementById('videoUpload');
            const resultGif = document.getElementById('resultGif');
            const downloadBtn = document.getElementById('downloadBtn');

            if (videoPlayer && videoPlayer.src) {
                URL.revokeObjectURL(videoPlayer.src);
                videoPlayer.src = '';
            }
            if (resultGif && resultGif.src) {
                URL.revokeObjectURL(resultGif.src);
                resultGif.src = '';
            }
            if (downloadBtn) {
                downloadBtn.href = '';
            }

            if (videoSection) videoSection.classList.remove('active');
            if (controlsPanel) controlsPanel.style.display = 'none';
            if (actionSection) actionSection.style.display = 'none';
            if (previewSection) previewSection.classList.remove('active');
            if (videoUpload) videoUpload.value = '';

            document.getElementById('videoUploadSection').style.display = 'block';
            videoDuration = 0;
            currentVideoFile = null;
        }

        function resetSlideshow() {
            slideshowImages = [];
            document.getElementById('slideshowGrid').innerHTML = '';
            document.getElementById('imageUpload').value = '';
            document.getElementById('previewSection').classList.remove('active');
            switchMode('images');
        }

        function closePreview() {
            document.getElementById('previewSection').classList.remove('active');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>

</html>